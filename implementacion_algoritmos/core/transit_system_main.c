// ============================================================================
// main.c - Demo completo del Sistema de Transporte P√∫blico Inteligente
// ============================================================================
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Incluir todos los headers del sistema
#include "core/transit_system.h"
#include "algoritmos/route_planner.h"
#include "pricing/fare_calculator.h"
#include "realtime/delay_tracker.h"
#include "scheduling/schedule.h"

// ============================================================================
// FUNCIONES AUXILIARES PARA EL DEMO
// ============================================================================

void printSeparator(const char* title) {
    printf("\n");
    for (int i = 0; i < 60; i++) {
        printf("=");
    }
    printf("\nüéØ %s\n", title);
    for (int i = 0; i < 60; i++) {
        printf("=");
    }
    printf("\n");
}

void printStepHeader(int step, const char* description) {
    printf("\nüìç PASO %d: %s\n", step, description);
    printf("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n");
}

void pauseDemo() {
    printf("\n‚è∏Ô∏è  Presiona Enter para continuar...");
    getchar();
}

// ============================================================================
// FUNCI√ìN PRINCIPAL DE DEMOSTRACI√ìN
// ============================================================================

int main() {
    printf("üöá ===== SISTEMA DE TRANSPORTE P√öBLICO INTELIGENTE =====\n");
    printf("üéâ ¬°Bienvenido al demo completo del sistema!\n");
    printf("üìã Este demo mostrar√° todas las funcionalidades implementadas\n\n");

    pauseDemo();

    // ============================================================================
    // PASO 1: CREAR EL SISTEMA
    // ============================================================================
    printStepHeader(1, "CREACI√ìN DEL SISTEMA");

    TransitSystem* system = createTransitSystem(20, 10);
    if (!system) {
        printf("‚ùå Error cr√≠tico: No se pudo crear el sistema\n");
        return 1;
    }

    printf("‚úÖ Sistema creado exitosamente\n");
    pauseDemo();

    // ============================================================================
    // PASO 2: CREAR Y AGREGAR ESTACIONES
    // ============================================================================
    printStepHeader(2, "CREACI√ìN DE ESTACIONES");

    // Crear estaciones del metro de Madrid (ejemplo)
    Station* atocha = createStation(1, "Atocha", 40.4063, -3.6906, 1, true);
    Station* sol = createStation(2, "Sol", 40.4169, -3.7033, 1, true);
    Station* plaza_castilla = createStation(3, "Plaza de Castilla", 40.4647, -3.6884, 2, false);
    Station* retiro = createStation(4, "Retiro", 40.4152, -3.6829, 1, true);
    Station* nuevos_ministerios = createStation(5, "Nuevos Ministerios", 40.4467, -3.6931, 2, true);
    Station* chamartin = createStation(6, "Chamart√≠n", 40.4730, -3.6802, 2, true);

    // Agregar estaciones al sistema
    printf("\nüöâ Agregando estaciones al sistema...\n");
    addStationToSystem(system, atocha);
    addStationToSystem(system, sol);
    addStationToSystem(system, plaza_castilla);
    addStationToSystem(system, retiro);
    addStationToSystem(system, nuevos_ministerios);
    addStationToSystem(system, chamartin);

    printf("\nüìä Estaciones agregadas: %d\n", system->station_count);
    pauseDemo();

    // ============================================================================
    // PASO 3: CREAR Y AGREGAR L√çNEAS
    // ============================================================================
    printStepHeader(3, "CREACI√ìN DE L√çNEAS DE TRANSPORTE");

    // Crear l√≠neas
    Line* linea1 = createLine(1, "L1", "#0066CC", 0); // Metro azul
    Line* linea2 = createLine(2, "L2", "#FF0000", 0); // Metro rojo
    Line* bus47 = createLine(3, "Bus47", "#00AA00", 1); // Autob√∫s verde

    printf("\nüöá Configurando L√≠nea 1 (L1)...\n");
    addStationToLine(linea1, atocha, 3);        // 3 min hasta Sol
    addStationToLine(linea1, sol, 4);           // 4 min hasta Nuevos Ministerios
    addStationToLine(linea1, nuevos_ministerios, 5); // 5 min hasta Plaza Castilla
    addStationToLine(linea1, plaza_castilla, 0); // Final de l√≠nea

    printf("\nüöá Configurando L√≠nea 2 (L2)...\n");
    addStationToLine(linea2, retiro, 2);        // 2 min hasta Sol
    addStationToLine(linea2, sol, 6);           // 6 min hasta Chamart√≠n
    addStationToLine(linea2, chamartin, 0);     // Final de l√≠nea

    printf("\nüöå Configurando Bus 47...\n");
    addStationToLine(bus47, sol, 8);            // 8 min hasta Plaza Castilla
    addStationToLine(bus47, plaza_castilla, 0); // Final de l√≠nea

    // Agregar l√≠neas al sistema
    printf("\nüîó Integrando l√≠neas en el sistema...\n");
    addLineToSystem(system, linea1);
    addLineToSystem(system, linea2);
    addLineToSystem(system, bus47);

    pauseDemo();

    // ============================================================================
    // PASO 4: CONFIGURAR HORARIOS
    // ============================================================================
    printStepHeader(4, "CONFIGURACI√ìN DE HORARIOS");

    // Crear horarios para las l√≠neas
    Time first_service = {6, 0};   // 6:00 AM
    Time last_service = {23, 30};  // 11:30 PM

    Schedule* schedule_l1 = createSchedule(1, 5, first_service, last_service); // Cada 5 min
    Schedule* schedule_l2 = createSchedule(2, 7, first_service, last_service); // Cada 7 min
    Schedule* schedule_bus = createSchedule(3, 12, first_service, last_service); // Cada 12 min

    printf("\nüìÖ Generando horarios autom√°ticos...\n");
    generateSchedule(schedule_l1);
    generateSchedule(schedule_l2);
    generateSchedule(schedule_bus);

    // Agregar horarios al sistema
    addScheduleToSystem(system, schedule_l1);
    addScheduleToSystem(system, schedule_l2);
    addScheduleToSystem(system, schedule_bus);

    pauseDemo();

    // ============================================================================
    // PASO 5: MOSTRAR ESTADO DEL SISTEMA
    // ============================================================================
    printStepHeader(5, "ESTADO ACTUAL DEL SISTEMA");

    printTransitSystem(system);

    printf("\nüîç Validando sistema...\n");
    if (validateTransitSystem(system)) {
        printf("‚úÖ Sistema validado correctamente\n");
    } else {
        printf("‚ö†Ô∏è Sistema tiene problemas\n");
    }

    pauseDemo();

    // ============================================================================
    // PASO 6: PLANIFICACI√ìN DE RUTAS
    // ============================================================================
    printStepHeader(6, "PLANIFICACI√ìN DE RUTAS");

    printf("üó∫Ô∏è Buscando rutas: Atocha ‚Üí Plaza de Castilla\n\n");

    // Ruta m√°s r√°pida
    Time departure = {8, 30}; // 8:30 AM
    printf("‚ö° Buscando ruta m√°s r√°pida (salida 8:30)...\n");
    Route* fastest_route = findFastestRoute(system, atocha, plaza_castilla, departure);

    if (fastest_route) {
        printf("‚úÖ Ruta m√°s r√°pida encontrada:\n");
        printRoute(fastest_route);
    } else {
        printf("‚ùå No se encontr√≥ ruta r√°pida\n");
    }

    pauseDemo();

    // Ruta m√°s barata
    printf("üí∞ Buscando ruta m√°s barata...\n");
    Route* cheapest_route = findCheapestRoute(system, atocha, plaza_castilla);

    if (cheapest_route) {
        printf("‚úÖ Ruta m√°s barata encontrada:\n");
        printRouteCompact(cheapest_route);
    } else {
        printf("‚ùå No se encontr√≥ ruta barata\n");
    }

    pauseDemo();

    // M√∫ltiples opciones
    printf("üîÑ Buscando m√∫ltiples opciones (m√°ximo 2 transbordos)...\n");
    int route_count;
    Route** multiple_routes = findRoutesWithTransfers(system, atocha, plaza_castilla, 2, &route_count);

    if (multiple_routes && route_count > 0) {
        printf("‚úÖ Encontradas %d opciones:\n", route_count);
        for (int i = 0; i < route_count; i++) {
            printf("\nüó∫Ô∏è Opci√≥n %d:\n", i + 1);
            printRouteCompact(multiple_routes[i]);
        }
    } else {
        printf("‚ùå No se encontraron rutas alternativas\n");
    }

    pauseDemo();

    // ============================================================================
    // PASO 7: C√ÅLCULO DE TARIFAS
    // ============================================================================
    printStepHeader(7, "SISTEMA DE TARIFAS Y DESCUENTOS");

    if (fastest_route) {
        printf("üí≥ Calculando tarifas para la ruta m√°s r√°pida...\n");

        // Calcular tarifa total
        double total_fare = calculateTotalFare(fastest_route, system->fares);
        fastest_route->total_cost = total_fare;

        // Probar tarjeta de estudiante
        printf("\nüéì Probando tarjeta de estudiante...\n");
        DiscountCard* student_card = createDiscountCard(CARD_STUDENT, "Mar√≠a Garc√≠a", 25.0);
        double student_fare = calculateDiscountedFare(fastest_route, student_card, system->fares);

        // Probar recargo por hora pico
        printf("\n‚è∞ Aplicando recargo por hora pico...\n");
        double peak_surcharge = calculatePeakHourSurcharge(fastest_route, departure);

        printf("\nüìä RESUMEN DE TARIFAS:\n");
        printf("   üí∞ Tarifa normal: $%.2f\n", total_fare);
        printf("   üéì Con descuento estudiantil: $%.2f\n", student_fare);
        printf("   ‚è∞ Recargo hora pico: +$%.2f\n", peak_surcharge);

        destroyDiscountCard(student_card);
    }

    pauseDemo();

    // ============================================================================
    // PASO 8: SIMULACI√ìN DE RETRASOS
    // ============================================================================
    printStepHeader(8, "SIMULACI√ìN DE RETRASOS EN TIEMPO REAL");

    printf("üö® Simulando retrasos en el sistema...\n\n");

    // Simular retraso en L1
    printf("‚ö†Ô∏è Aplicando retraso a L√≠nea 1...\n");
    updateDelays(system, linea1, 8); // 8 minutos de retraso

    // Simular problema en Bus 47
    printf("üö´ Simulando problema en Bus 47...\n");
    updateDelays(system, bus47, 25); // 25 minutos de retraso

    // Mostrar estado de retrasos
    printf("\nüìä Estado actual de retrasos:\n");
    printDelayStatus(system);

    // Analizar rendimiento del sistema
    printf("üìà An√°lisis de rendimiento:\n");
    analyzeSystemPerformance(system);

    // Verificar si necesita rerouteo
    printf("üîç Verificando necesidad de rerouteo...\n");
    if (shouldReroutePassengers(system, linea1->id)) {
        printf("‚ö†Ô∏è Se recomienda reroutear pasajeros de L1\n");
    }

    if (shouldReroutePassengers(system, bus47->id)) {
        printf("‚ö†Ô∏è Se recomienda reroutear pasajeros de Bus 47\n");
    }

    pauseDemo();

    // ============================================================================
    // PASO 9: GENERACI√ìN DE ALERTAS
    // ============================================================================
    printStepHeader(9, "SISTEMA DE ALERTAS AUTOM√ÅTICAS");

    printf("üì¢ Generando alertas autom√°ticas...\n");
    generateAutomaticAlerts(system);

    // Crear alerta manual
    printf("\nüì± Creando alerta manual...\n");
    DelayAlert* manual_alert = createDelayAlert(ALERT_SERVICE_DISRUPTION,
                                               bus47->id, 25,
                                               "Incidente en v√≠a - servicio suspendido temporalmente");
    if (manual_alert) {
        broadcastAlert(system, manual_alert);
        destroyDelayAlert(manual_alert);
    }

    pauseDemo();

    // ============================================================================
    // PASO 10: REPORTES Y ESTAD√çSTICAS
    // ============================================================================
    printStepHeader(10, "GENERACI√ìN DE REPORTES");

    printf("üìÑ Generando reportes del sistema...\n");

    // Generar reporte de retrasos
    generateDelayReport(system, "reporte_retrasos.txt");

    // Generar reporte de tarifa (si hay ruta)
    if (fastest_route) {
        generateFareReport(fastest_route, system->fares, "reporte_tarifa.txt");
    }

    // Mostrar estad√≠sticas finales
    printf("\nüìä ESTAD√çSTICAS FINALES DEL SISTEMA:\n");
    printSystemSummary(system);

    printf("\nüéØ M√âTRICAS DE RENDIMIENTO:\n");
    printf("   ‚ö° Rutas planificadas: %s\n", fastest_route ? "‚úÖ" : "‚ùå");
    printf("   üí∞ Sistema de tarifas: ‚úÖ\n");
    printf("   ‚è∞ Seguimiento tiempo real: ‚úÖ\n");
    printf("   üì± Sistema de alertas: ‚úÖ\n");
    printf("   üìä Generaci√≥n de reportes: ‚úÖ\n");

    pauseDemo();

    // ============================================================================
    // PASO 11: LIMPIEZA Y FINALIZACI√ìN
    // ============================================================================
    printStepHeader(11, "LIMPIEZA DEL SISTEMA");

    printf("üßπ Liberando memoria...\n");

    // Limpiar rutas
    if (fastest_route) {
        destroyRoute(fastest_route);
        printf("‚úÖ Ruta r√°pida destruida\n");
    }

    if (cheapest_route) {
        destroyRoute(cheapest_route);
        printf("‚úÖ Ruta barata destruida\n");
    }

    if (multiple_routes) {
        for (int i = 0; i < route_count; i++) {
            if (multiple_routes[i]) {
                destroyRoute(multiple_routes[i]);
            }
        }
        free(multiple_routes);
        printf("‚úÖ Rutas m√∫ltiples destruidas\n");
    }

    // Destruir sistema completo
    destroyTransitSystem(system);
    printf("‚úÖ Sistema de transporte destruido\n");

    // ============================================================================
    // FINALIZACI√ìN
    // ============================================================================
    printSeparator("DEMO COMPLETADO");

    printf("üéâ ¬°Demo completado exitosamente!\n\n");
    printf("üìã RESUMEN DE FUNCIONALIDADES PROBADAS:\n");
    printf("   ‚úÖ Creaci√≥n y gesti√≥n del sistema\n");
    printf("   ‚úÖ Administraci√≥n de estaciones y l√≠neas\n");
    printf("   ‚úÖ Configuraci√≥n de horarios\n");
    printf("   ‚úÖ Planificaci√≥n inteligente de rutas\n");
    printf("   ‚úÖ Sistema de tarifas con descuentos\n");
    printf("   ‚úÖ Seguimiento de retrasos en tiempo real\n");
    printf("   ‚úÖ Sistema de alertas autom√°ticas\n");
    printf("   ‚úÖ Generaci√≥n de reportes\n");
    printf("   ‚úÖ Gesti√≥n completa de memoria\n\n");

    printf("üöá El Sistema de Transporte P√∫blico Inteligente est√° funcionando correctamente.\n");
    printf("üìÅ Revisa los archivos 'reporte_retrasos.txt' y 'reporte_tarifa.txt'\n");
    printf("üéØ ¬°Gracias por probar el sistema!\n\n");

    return 0;
}

// ============================================================================
// FUNCIONES ADICIONALES PARA TESTING
// ============================================================================

void runQuickTest() {
    printf("üß™ Ejecutando test r√°pido...\n");

    TransitSystem* test_system = createTransitSystem(5, 3);

    Station* s1 = createStation(1, "Test1", 0.0, 0.0, 1, true);
    Station* s2 = createStation(2, "Test2", 1.0, 1.0, 1, true);

    addStationToSystem(test_system, s1);
    addStationToSystem(test_system, s2);

    Line* test_line = createLine(1, "TestLine", "#FF0000", 0);
    addStationToLine(test_line, s1, 5);
    addStationToLine(test_line, s2, 0);
    addLineToSystem(test_system, test_line);

    if (validateTransitSystem(test_system)) {
        printf("‚úÖ Test r√°pido: PAS√ì\n");
    } else {
        printf("‚ùå Test r√°pido: FALL√ì\n");
    }

    destroyTransitSystem(test_system);
}

bool addScheduleToSystem(TransitSystem* system, Schedule* schedule) {
    if (!system || !schedule) {
        printf("‚ùå Error: Sistema o horario nulos\n");
        return false;
    }

    if (system->schedules_count >= system->capacity_schedules) {
        printf("‚ùå Error: Capacidad m√°xima de horarios alcanzada (%d)\n",
               system->capacity_schedules);
        return false;
    }

    // Verificar que existe la l√≠nea para este horario
    Line* line = findLineById(system, schedule->line_id);
    if (!line) {
        printf("‚ùå Error: No existe l√≠nea con ID %d para el horario\n", schedule->line_id);
        return false;
    }

    // Verificar que no existe horario para esta l√≠nea
    for (int i = 0; i < system->schedules_count; i++) {
        if (system->schedules[i]->line_id == schedule->line_id) {
            printf("‚ùå Error: Ya existe horario para l√≠nea ID %d (%s)\n",
                   schedule->line_id, line->name);
            return false;
        }
    }

    system->schedules[system->schedules_count] = schedule;
    system->schedules_count++;

    printf("‚ûï Horario agregado para l√≠nea %s (ID: %d)\n", line->name, schedule->line_id);
    printf("   üïê Servicio: %02d:%02d - %02d:%02d, frecuencia: %d min\n",
           schedule->first_service.hour, schedule->first_service.minute,
           schedule->last_service.hour, schedule->last_service.minute,
           schedule->frequency_minutes);

    return true;
}

Station* findStationById(TransitSystem* system, int id) {
    if (!system) return NULL;

    for (int i = 0; i < system->station_count; i++) {
        if (system->stations[i]->id == id) {
            return system->stations[i];
        }
    }
    return NULL;
}

Station* findStationByName(TransitSystem* system, const char* name) {
    if (!system || !name) return NULL;

    for (int i = 0; i < system->station_count; i++) {
        if (strcmp(system->stations[i]->name, name) == 0) {
            return system->stations[i];
        }
    }
    return NULL;
}

Line* findLineById(TransitSystem* system, int id) {
    if (!system) return NULL;

    for (int i = 0; i < system->lines_count; i++) {
        if (system->lines[i]->id == id) {
            return system->lines[i];
        }
    }
    return NULL;
}

Line* findLineByName(TransitSystem* system, const char* name) {
    if (!system || !name) return NULL;

    for (int i = 0; i < system->lines_count; i++) {
        if (strcmp(system->lines[i]->name, name) == 0) {
            return system->lines[i];
        }
    }
    return NULL;
}

void printSystemSummary(TransitSystem* system) {
    if (!system) {
        printf("‚ùå Sistema nulo\n");
        return;
    }

    printf("üìä RESUMEN DEL SISTEMA:\n");
    printf("   üöâ %d estaciones | üöá %d l√≠neas | üìÖ %d horarios\n",
           system->station_count, system->lines_count, system->schedules_count);

    if (system->station_count > 0 && system->lines_count > 0) {
        printf("   ‚úÖ Sistema operativo\n");
    } else {
        printf("   ‚ö†Ô∏è Sistema incompleto\n");
    }
}

int getSystemStationCount(TransitSystem* system) {
    return system ? system->station_count : 0;
}

int getSystemLineCount(TransitSystem* system) {
    return system ? system->lines_count : 0;
}

int getSystemScheduleCount(TransitSystem* system) {
    return system ? system->schedules_count : 0;
}

bool isSystemEmpty(TransitSystem* system) {
    return !system || (system->station_count == 0 && system->lines_count == 0);
}
